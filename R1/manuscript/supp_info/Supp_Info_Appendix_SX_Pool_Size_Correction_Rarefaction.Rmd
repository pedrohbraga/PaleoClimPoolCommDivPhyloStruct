---
header-includes:
   - \usepackage[default]{sourcesanspro}
   - \usepackage[T1]{fontenc}
mainfont: SourceSansPro
output:
  pdf_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(ggpubr)
library(phytools)
library(PhyloMeasures)
library(dplyr)

knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE)

source("~/chapter-PaleoClimPoolCommDivPhyloStruct/R1/scripts/SX_fun_ses.opt.rarefaction.phylostr.R")
```

```{r include=FALSE}
generate_community <- function(T,
                               preset_ncommunities, 
                               param = 1) {
  preset_nspecies <- length(T)
  repeat {
    E <- scale(rnorm(preset_ncommunities))
    T <- scale(T)
    # one trait, one environmental variable
    L <- matrix(data = 0, 
                nrow = preset_ncommunities, 
                ncol = preset_nspecies)
    for (j in 1:preset_nspecies) {
      L[, j] <- rbinom(preset_ncommunities, 
                       1, 
                       (1 / (1 + exp(-param * E * T[j]))))
    }
    n_species_c <- sum(colSums(L) != 0) #
    n_communities_c <- sum(rowSums(L) != 0)
    if ((n_species_c == preset_nspecies) & (n_communities_c == preset_ncommunities)) {
      break
    }
  }
  colnames(L) <- rownames(T)
  output <- list(L = L, E = E)
  return(output)
}

# Set seed to reproduce the same results

set.seed(123)

# Determine the number of species in the phylogenetic pool, which should match a
# hypothetical global pool

n.species <- 1000

# Simulare a pure-birth tree with n.species on it

large.tree <- pbtree(n = n.species, 
                     scale = 1)

# Obtain species names from the phylogenetic tree, which will be used to
# simulate ecological communities

species.names <- large.tree$tip.label

# Determine the number of ecological communities we would like to sample

n.communities <- 10000

# Determine the strength the environmental
# requirements of species

strength.Env.Phylo <- 5

# Sinulate a trait under Brownian motion in the phylogenetic tree 

T.phylo <- fastBM(large.tree, 
                  sig2 = 0.1)

# Simulate a large scale region containing n.communities communities

species.data.region.sim <- generate_community(T = T.phylo, 
                                              preset_ncommunities = n.communities, 
                                              param = strength.Env.Phylo)

# Obtain the presence-absence matrix element This matrix comprises the largest
# spatial scale region, from which we will subset smaller scale regions

species.data.region <- species.data.region.sim$L

# Subset a smaller scale region containing the first subset.n.species (columns)
# and the first subset.n.comm (rows)

subset.n.species <- 250
subset.n.comm <- 5000

subset.species.data.region <- species.data.region[1:subset.n.comm, 
                                                  1:subset.n.species]

# We will now create a gradient of phylogenetic sampling pools that increments
# species to the local subset.species.data.region species pool.

# This is done by first subsetting all species names that are not part of the
# subset.species.data.region pool, then sampling n species names from it, and
# then adding these names to the species names that are within the
# subset.species.data.region; and then storing it to the larger.pool object.

# The original phylogenetic tree is then pruned to the larger.pool, so it
# contains the sampling pool that we have created.

# Finally, to obtain and compare how the phylogenetic relatedness of the
# communities is in relation to a given phylogenetic sampling pool, we apply two
# approaches:

# The first approach is the traditional method for calculating standardized
# effect sizes for the phylogenetic relatdness (from Webb 2000).

# The second approach consists of applying rarefaction in the calculation of
# phylogenetic relatedness for the ecological communities. In this rarefaction
# approach, we randomly subsample (rarefy) species from the phylogenetic pool to
# a subset of size m multiple times and calculate the average of standardized
# effect sizes of phylogenetic relatdness of those subsets.

extra.species.for.pool <- seq(50, 
                              c(n.species - subset.n.species), 
                              by = 50)

mpd.pool.comparisons <- data.frame()

# n = extra.species.for.pool[1]

for(n in extra.species.for.pool){
  larger.pool <- large.tree$tip.label[! large.tree$tip.label %in% colnames(subset.species.data.region)] %>%
    sample(n) %>%
    c(colnames(subset.species.data.region))
  
  smaller.tree <- keep.tip(large.tree, 
                           larger.pool)
  
  if(round(length(smaller.tree$tip.label)/3) < subset.n.species){
    
    mpd.sampling.pool <- opt.rarefaction.mpd(n.species.rarefac = round(length(smaller.tree$tip.label)/3), 
                                             phylo.tree = smaller.tree,
                                             species.data = subset.species.data.region,
                                             n.rep = 100, 
                                             n.cores = 8)
    
    mpd.sampling.pool$ses.mpd.z.query.rarefac$pool.size <- length(smaller.tree$tip.label)
    
    mpd.pool.comparisons <- rbind(mpd.pool.comparisons, mpd.sampling.pool$ses.mpd.z.query.rarefac)
  }
}


mntd.pool.comparisons <- data.frame()

for(n in extra.species.for.pool){
  
  larger.pool <- large.tree$tip.label[! large.tree$tip.label %in% colnames(subset.species.data.region)] %>%
    sample(n) %>%
    c(colnames(subset.species.data.region))
  
  smaller.tree <- keep.tip(large.tree, 
                           larger.pool)
  if(round(length(smaller.tree$tip.label)/3) < subset.n.species){
    mntd.sampling.pool <- opt.rarefaction.mntd(n.species.rarefac = round(length(smaller.tree$tip.label)/3), 
                                               phylo.tree = smaller.tree,
                                               species.data = subset.species.data.region,
                                               n.rep = 100, 
                                               n.cores = 8)
    
    mntd.sampling.pool$ses.mntd.z.query.rarefac$pool.size <- length(smaller.tree$tip.label)
    
    mntd.pool.comparisons <- rbind(mntd.pool.comparisons, mntd.sampling.pool$ses.mntd.z.query.rarefac)
  }
}

mpd.fixed.pool.comparisons <- data.frame()

# n = extra.species.for.pool[1]

for(n in extra.species.for.pool){
  
  larger.pool <- large.tree$tip.label[! large.tree$tip.label %in% colnames(subset.species.data.region)] %>%
    sample(n) %>%
    c(colnames(subset.species.data.region))
  
  smaller.tree <- keep.tip(large.tree, 
                           larger.pool)
  if(100 < subset.n.species){    
    mpd.sampling.pool <- opt.rarefaction.mpd(n.species.rarefac = 100, 
                                             phylo.tree = smaller.tree,
                                             species.data = subset.species.data.region,
                                             n.rep = 100, 
                                             n.cores = 8)
    
    mpd.sampling.pool$ses.mpd.z.query.rarefac$pool.size <- length(smaller.tree$tip.label)
    
    mpd.fixed.pool.comparisons <- rbind(mpd.fixed.pool.comparisons, mpd.sampling.pool$ses.mpd.z.query.rarefac)
  }
}


mntd.fixed.pool.comparisons <- data.frame()

for(n in extra.species.for.pool){
  
  larger.pool <- large.tree$tip.label[! large.tree$tip.label %in% colnames(subset.species.data.region)] %>%
    sample(n) %>%
    c(colnames(subset.species.data.region))
  
  smaller.tree <- keep.tip(large.tree, 
                           larger.pool)
  if(100 < subset.n.species){    
    mntd.sampling.pool <- opt.rarefaction.mntd(n.species.rarefac = 100, 
                                               phylo.tree = smaller.tree,
                                               species.data = subset.species.data.region,
                                               n.rep = 100, 
                                               n.cores = 8)
    
    mntd.sampling.pool$ses.mntd.z.query.rarefac$pool.size <- length(smaller.tree$tip.label)
    
    mntd.fixed.pool.comparisons <- rbind(mntd.fixed.pool.comparisons, mntd.sampling.pool$ses.mntd.z.query.rarefac)
  }
}
```


```{r echo=FALSE, eval = TRUE}
NRI.fixed.pool.size.rarefac<- ggplot(mpd.fixed.pool.comparisons, aes(x = pool.size, 
                                                                     y = nri.rarefac.mean, 
                                                                     group = pool.size)) +
  geom_boxplot() +
  scale_y_continuous() +
  geom_hline(yintercept = 0,
             alpha = 0.4) +
  labs(y = expression(NRI[raref[FIX]]), 
       x = "Species in the phylogeny") +
  theme_minimal() +
  theme_minimal(base_size = 20) +
  theme(strip.background = element_rect(fill = "white",
                                        linetype = NULL,
                                        color = "white"),
        strip.text = element_text(color = "black",
                                  face = "bold",
                                  size = 15),
        axis.text.y = element_text(face = "bold"),
        axis.text.x = element_text(face = "bold"),
        axis.title = element_text(size = 16, face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 16),
        legend.title.align = 0.5,
        legend.margin=margin(0, 0, 0, 0),
        legend.box.margin=margin(-5, -5, 2, -5)
  )


NTI.fixed.pool.size.rarefac<- ggplot(mntd.fixed.pool.comparisons, aes(x = pool.size, 
                                                                      y = nti.rarefac.mean, 
                                                                      group = pool.size)) +
  geom_boxplot() +
  scale_y_continuous() +
  geom_hline(yintercept = 0,
             alpha = 0.4) +
  labs(y = expression(NTI[raref[FIX]]), 
       x = "Species in the phylogeny") +
  theme_minimal(base_size = 20) +
  theme(strip.background = element_rect(fill = "white",
                                        linetype = NULL,
                                        color = "white"),
        strip.text = element_text(color = "black",
                                  face = "bold",
                                  size = 15),
        axis.text.y = element_text(face = "bold"),
        axis.text.x = element_text(face = "bold"),
        axis.title = element_text(size = 16, face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 16),
        legend.title.align = 0.5,
        legend.margin=margin(0, 0, 0, 0),
        legend.box.margin=margin(-5, -5, 2, -5)
  )



NRI.pool.size <- ggplot(mpd.pool.comparisons, aes(x = pool.size, 
                                                  y = nri.sec, 
                                                  group = pool.size)) +
  geom_boxplot() +
  scale_y_continuous() +
  geom_hline(yintercept = 0,
             alpha = 0.4) +
  labs(y = expression(NRI), 
       x = "Species in the phylogeny") +
  theme_minimal() +
  theme_minimal(base_size = 20) +
  theme(strip.background = element_rect(fill = "white",
                                        linetype = NULL,
                                        color = "white"),
        strip.text = element_text(color = "black",
                                  face = "bold",
                                  size = 15),
        axis.text.y = element_text(face = "bold"),
        axis.text.x = element_text(face = "bold"),
        axis.title = element_text(size = 16, face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 16),
        legend.title.align = 0.5,
        legend.margin=margin(0, 0, 0, 0),
        legend.box.margin=margin(-5, -5, 2, -5)
  )


NRI.pool.size.rarefac<- ggplot(mpd.pool.comparisons, aes(x = pool.size, 
                                                         y = nri.rarefac.mean, 
                                                         group = pool.size)) +
  geom_boxplot() +
  scale_y_continuous() +
  geom_hline(yintercept = 0,
             alpha = 0.4) +
  labs(y = expression(NRI[raref[REL]]), 
       x = "Species in the phylogeny") +
  theme_minimal() +
  theme_minimal(base_size = 20) +
  theme(strip.background = element_rect(fill = "white",
                                        linetype = NULL,
                                        color = "white"),
        strip.text = element_text(color = "black",
                                  face = "bold",
                                  size = 15),
        axis.text.y = element_text(face = "bold"),
        axis.text.x = element_text(face = "bold"),
        axis.title = element_text(size = 16, face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 16),
        legend.title.align = 0.5,
        legend.margin=margin(0, 0, 0, 0),
        legend.box.margin=margin(-5, -5, 2, -5)
  )


NTI.pool.size <- ggplot(mntd.pool.comparisons, aes(x = pool.size, 
                                                   y = nti.sec, 
                                                   group = pool.size)) +
  geom_boxplot() +
  scale_y_continuous() +
  geom_hline(yintercept = 0,
             alpha = 0.4) +
  labs(y = expression(NTI), 
       x = "Species in the phylogeny") +
  theme_minimal(base_size = 20) +
  theme(strip.background = element_rect(fill = "white",
                                        linetype = NULL,
                                        color = "white"),
        strip.text = element_text(color = "black",
                                  face = "bold",
                                  size = 15),
        axis.text.y = element_text(face = "bold"),
        axis.text.x = element_text(face = "bold"),
        axis.title = element_text(size = 16, face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 16),
        legend.title.align = 0.5,
        legend.margin=margin(0, 0, 0, 0),
        legend.box.margin=margin(-5, -5, 2, -5)
  )


NTI.pool.size.rarefac<- ggplot(mntd.pool.comparisons, aes(x = pool.size, 
                                                          y = nti.rarefac.mean, 
                                                          group = pool.size)) +
  geom_boxplot() +
  scale_y_continuous() +
  geom_hline(yintercept = 0,
             alpha = 0.4) +
  labs(y = expression(NTI[raref[REL]]), 
       x = "Species in the phylogeny") +
  theme_minimal(base_size = 20) +
  theme(strip.background = element_rect(fill = "white",
                                        linetype = NULL,
                                        color = "white"),
        strip.text = element_text(color = "black",
                                  face = "bold",
                                  size = 15),
        axis.text.y = element_text(face = "bold"),
        axis.text.x = element_text(face = "bold"),
        axis.title = element_text(size = 16, face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 16),
        legend.title.align = 0.5,
        legend.margin=margin(0, 0, 0, 0),
        legend.box.margin=margin(-5, -5, 2, -5)
  )


### Combining plots into a single figure ###

fig.NRI.NTI.Realm.boxplot.phyloSampling <- ggarrange(
  NRI.pool.size +
    theme(axis.title.x = element_blank()), 
  NTI.pool.size+
    theme(axis.title.x = element_blank()),
  NRI.pool.size.rarefac+
    theme(axis.title.x = element_blank()),
  NTI.pool.size.rarefac+
    theme(axis.title.x = element_blank()),
  NRI.fixed.pool.size.rarefac,
  NTI.fixed.pool.size.rarefac,
  labels = c("A", "B", "C", "D", "E", "F"),
  ncol = 2, nrow = 3,
  widths = c(1, 1),
  heights = c(1, 1.1),
  align = "v",
  common.legend = TRUE,
  legend = "bottom"
)

```


### Study
### The historical and contemporary processes driving global phylogenetic structure – the case of bat communities

### Supplementary Information 3

### Appendix SX. Assessing and correcting for the sampling pool size bias on indices of community phylogenetic relatedness

### Sampling pool size-dependence in indices for phylogenetic community structure

The magnitude of standardized effect sizes index values for phylogenetic community structure may increase with the size of the phylogeny used to compute the null models (Sandel, 2018). This bias requires that studies seeking to compare the standardized effect sizes of phylogenetic relatedness between communities to assess whether these comparisons hold after correcting for this problem.

One possible approach to correct for the sampling pool size bias is to repeatedly randomly subsample (_i.e._ rarefy) the community matrix to smaller sampling pool sizes, then to calculate the average indices for phylogenetic community structure [here, the net relatedness index (NRI) and the nearest taxon index (NTI); see Methods] across the rarefied subset (see Sandel, 2018). 

The resulting index from this procedure should show a negligible relationship with the size of the sampling pool (or size or richness of the phylogeny), but at the expense of losing power intrinsic to the rarefaction procedure (Sandel, 2018). The information relative from sampling pools that have less species than the size chosen for the subsampling procedure are is also lost. 

### Implementation

We used two rarefaction procedures to correct for the bias in the sampling pool size, one with a fixed-size for the rarefied sampling pools, and another with the length of rarefied sampling pools being relative to the original sampling pool size.

For the first procedure, we computed $\mathsf{NRI_{raref_{FIX}}}$ and $\mathsf{NTI_{raref_{FIX}}}$ by rarefying the community presence-absence matrix to a fixed number of species per region (here, 45) and computing NRI and NTI on this matrix. 

For the second case, we calculated sampling pool relative $\mathsf{NRI_{raref_{REL}}}$ and $\mathsf{NTI_{raref_{REL}}}$ by rarefying the community presence-absence matrix to one third of the number of species in the sampling pool of that region.

In both approaches, we repeated the rarefaction procedure 1000 times and reproduced the figures from our manuscript separately using the average fixed-size and relative-size rarefaction indices across replicates. The interpretation of the rarefied indices follow the same original ones for NRI and NTI (see Methods; Webb, 2000).

To demonstrate the influence of sampling pool size on the phylogenetic community structure indices and the robustness of both bias-correction approaches, we perform the same calculations on a simple set of simulations. We generated 10000 communities and a random pure-birth tree, both containing 1000 species, which represents the broad-scale sampling pool. We then subset 5000 communities and 250 species from the broad-scale sampling pool. We iteratively calculated $\mathsf{NRI}$, $\mathsf{NTI}$ $\mathsf{NRI_{raref_{FIX}}}$, $\mathsf{NTI_{raref_{FIX}}}$, $\mathsf{NRI_{raref_{REL}}}$ and $\mathsf{NTI_{raref_{REL}}}$ for sampling pool sizes increasing from 250 species to 1000 species, in increments of 50 species.

### Results

As demonstrated in Sandel (2018), the traditional community phylogenetic relatedness indices (NRI and NTI) increased with the size of the phylogenetic sampling pool in our simulated communities [as shown by $\mathsf{NRI}$ (net relatedness index) and $\mathsf{NTI}$ (nearest taxon index); A and B]. However, the rarefaction-based calculation of phylogenetic relatedness effectively removes the sampling pool size-dependence in the simulations (see Figure SX) and in our empirical data set (see Figure SX).

### Figures

**Figure SX.** The size of the phylogenetic sampling pool influences community phylogenetic relatedness index values of simulated communities [as shown by $\mathsf{NRI}$ (net relatedness index) and $\mathsf{NTI}$ (nearest taxon index); A and B]. Rarefaction with both fixed-size sub-sampling [$\mathsf{NRI_{raref_{FIX}}}$ and $\mathsf{NTI_{raref_{FIX}}}$; C and D] and relative-size sub-sampling [$\mathsf{NRI_{raref_{REL}}}$ and $\mathsf{NTI_{raref_{REL}}}$; E and F] removes the sampling pool size-dependence.

```{r echo=FALSE, eval = TRUE, fig.width = 12, fig.height = 18, fig.align = "center"}
fig.NRI.NTI.Realm.boxplot.phyloSampling
```

**Figure SX.** The size of the phylogenetic sampling pool influences community phylogenetic relatedness index values of simulated communities [as shown by $\mathsf{NRI}$ (net relatedness index) and $\mathsf{NTI}$ (nearest taxon index); A and B]. Rarefaction with both fixed-size sub-sampling [$\mathsf{NRI_{raref_{FIX}}}$ and $\mathsf{NTI_{raref_{FIX}}}$; C and D] and relative-size sub-sampling [$\mathsf{NRI_{raref_{REL}}}$ and $\mathsf{NTI_{raref_{REL}}}$; E and F] removes the sampling pool size-dependence.

```{r echo=FALSE, eval = TRUE, fig.width = 12, fig.height = 18, fig.align = "center"}
fig.NRI.NTI.Realm.boxplot.phyloSampling
```

